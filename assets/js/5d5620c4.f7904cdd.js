"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1926],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,p=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=s(n),m=a,g=c["".concat(p,".").concat(m)]||c[m]||d[m]||l;return n?i.createElement(g,r(r({ref:t},u),{},{components:n})):i.createElement(g,r({ref:t},u))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,r=new Array(l);r[0]=m;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[c]="string"==typeof e?e:a,r[1]=o;for(var s=2;s<l;s++)r[s]=n[s];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6176:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>p,default:()=>g,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var i=n(7462),a=n(3366),l=(n(7294),n(3905)),r=["components"],o={title:"ESM"},p=void 0,s={unversionedId:"esm",id:"esm",title:"ESM",description:"Version 3.0.0 of @oclif/core officially supports ESM plugin development and CJS/ESM interoperability, meaning that you can have a root plugin written with CJS and your bundled plugins written in ESM or vice versa.",source:"@site/../docs/esm.md",sourceDirName:".",slug:"/esm",permalink:"/docs/esm",draft:!1,editUrl:"https://github.com/oclif/oclif.github.io/tree/docs/docs/../docs/esm.md",tags:[],version:"current",lastUpdatedBy:"Mike Donnalley",lastUpdatedAt:1707166915,formattedLastUpdatedAt:"Feb 5, 2024",frontMatter:{title:"ESM"},sidebar:"docs",previous:{title:"Single Command CLI",permalink:"/docs/single_command_cli"},next:{title:"Themes",permalink:"/docs/themes"}},u={},c=[{value:"Interoperability Overview",id:"interoperability-overview",level:2},{value:"ESM Root plugin",id:"esm-root-plugin",level:3},{value:"CJS Root plugin",id:"cjs-root-plugin",level:3},{value:"Creating an ESM plugin",id:"creating-an-esm-plugin",level:2},{value:"Migrating a CJS plugin to ESM",id:"migrating-a-cjs-plugin-to-esm",level:2},{value:"Update bin scripts",id:"update-bin-scripts",level:3},{value:"bin/dev \u2192 bin/dev.js",id:"bindev--bindevjs",level:4},{value:"bin/run \u2192 bin/run.js",id:"binrun--binrunjs",level:4},{value:"Update tsconfig.json",id:"update-tsconfigjson",level:3},{value:"Update package.json to &quot;module&quot; type",id:"update-packagejson-to-module-type",level:3},{value:"Update references to bin scripts",id:"update-references-to-bin-scripts",level:3},{value:"Update mocharc settings",id:"update-mocharc-settings",level:3}],d={toc:c},m="wrapper";function g(e){var t=e.components,n=(0,a.Z)(e,r);return(0,l.kt)(m,(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Version 3.0.0 of ",(0,l.kt)("inlineCode",{parentName:"p"},"@oclif/core")," officially supports ESM plugin development and CJS/ESM interoperability, meaning that you can have a root plugin written with CJS and your bundled plugins written in ESM or vice versa."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#interoperability-overview"},"Interoperability Overview"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#esm-root-plugin"},"ESM Root plugin")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#cjs-root-plugin"},"CJS Root plugin")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#creating-an-esm-plugin"},"Creating an ESM plugin")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#migrating-a-cjs-plugin-to-esm"},"Migrating a CJS plugin to ESM"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#update-bin-scripts"},"Update bin scripts"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#bindev--bindevjs"},"bin/dev \u2192 bin/dev.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#binrun--binrunjs"},"bin/run \u2192 bin/run.js")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#update-tsconfigjson"},"Update tsconfig.json")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#update-packagejson-to-module-type"},'Update package.json to "module" type')),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#update-references-to-bin-scripts"},"Update references to bin scripts")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#update-mocharc-settings"},"Update mocharc settings"))))),(0,l.kt)("h2",{id:"interoperability-overview"},"Interoperability Overview"),(0,l.kt)("p",null,"Here's a high level overview of ESM/CJS interoperability:"),(0,l.kt)("h3",{id:"esm-root-plugin"},"ESM Root plugin"),(0,l.kt)("p",null,"\u2705 Install CJS plugins"),(0,l.kt)("p",null,"\u2705 Install ESM plugins"),(0,l.kt)("p",null,"\u2705 Link CJS plugins"),(0,l.kt)("p",null,"\u26a0\ufe0f Link ESM plugins"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Auto-compilation will ",(0,l.kt)("strong",{parentName:"li"},"not")," work with linked ESM plugins. Instead, oclif will use the plugin's compiled source - this means that you must compile the plugin yourself before executing any of the commands. We plan to support this again once the node ecosystem offers more comprehensive native support for ESM.")),(0,l.kt)("h3",{id:"cjs-root-plugin"},"CJS Root plugin"),(0,l.kt)("p",null,"\u2705 Install CJS plugins"),(0,l.kt)("p",null,"\u2705 Install ESM plugins"),(0,l.kt)("p",null,"\u2705 Link CJS plugins"),(0,l.kt)("p",null,"\u26a0\ufe0f Link ESM plugins"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Auto-compilation will ",(0,l.kt)("strong",{parentName:"li"},"not")," work with linked ESM plugins. Instead, oclif will use the plugin's compiled source - this means that you must compile the plugin yourself before executing any of the commands. We plan to support this again once the node ecosystem offers more comprehensive native support for ESM.")),(0,l.kt)("h2",{id:"creating-an-esm-plugin"},"Creating an ESM plugin"),(0,l.kt)("p",null,"To generate a new ESM plugin from the ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/oclif/hello-world-esm"},"hello-world-esm template")," run the ",(0,l.kt)("inlineCode",{parentName:"p"},"oclif generate")," command and select ",(0,l.kt)("inlineCode",{parentName:"p"},"ESM")," when it prompts you to select a module type:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ npx oclif generate my-esm-plugin\n? Select a module type\n  CommonJS\n\u276f ESM\n")),(0,l.kt)("h2",{id:"migrating-a-cjs-plugin-to-esm"},"Migrating a CJS plugin to ESM"),(0,l.kt)("h3",{id:"update-bin-scripts"},"Update bin scripts"),(0,l.kt)("p",null,"First you will need to update the bin scripts under the ",(0,l.kt)("inlineCode",{parentName:"p"},"bin")," directory."),(0,l.kt)("h4",{id:"bindev--bindevjs"},"bin/dev \u2192 bin/dev.js"),(0,l.kt)("p",null,"Rename ",(0,l.kt)("inlineCode",{parentName:"p"},"bin/dev")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"bin/dev.js")," and replace the existing code with the following:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"#!/usr/bin/env -S node --loader ts-node/esm --no-warnings=ExperimentalWarning\n// eslint-disable-next-line node/shebang\nasync function main() {\n  const {execute} = await import('@oclif/core')\n  await execute({development: true, dir: import.meta.url})\n}\n\nawait main()\n")),(0,l.kt)("p",null,"This leverages oclif's ",(0,l.kt)("inlineCode",{parentName:"p"},"execute")," function which handles all the development setup for you. You no longer need set the ",(0,l.kt)("inlineCode",{parentName:"p"},"NODE_ENV")," env var or register the project with ",(0,l.kt)("inlineCode",{parentName:"p"},"ts-node"),". You can still adjust oclif ",(0,l.kt)("inlineCode",{parentName:"p"},"settings")," before executing the CLI. For example,"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"#!/usr/bin/env -S node --loader ts-node/esm --no-warnings=ExperimentalWarning\n// eslint-disable-next-line node/shebang\nasync function main() {\n  const {execute, settings} = await import('@oclif/core')\n  settings.performanceEnabled = true\n  await execute({development: true, dir: import.meta.url})\n}\n\nawait main()\n")),(0,l.kt)("h4",{id:"binrun--binrunjs"},"bin/run \u2192 bin/run.js"),(0,l.kt)("p",null,"Rename ",(0,l.kt)("inlineCode",{parentName:"p"},"bin/run")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"bin/run.js")," and replace the existing code with the following:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"#!/usr/bin/env node\nasync function main() {\n  const {execute} = await import('@oclif/core')\n  await execute({dir: import.meta.url})\n}\n\nawait main()\n")),(0,l.kt)("h3",{id:"update-tsconfigjson"},"Update tsconfig.json"),(0,l.kt)("p",null,"After updating the bin scripts you now need to update the ",(0,l.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," to include the following options:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "compilerOptions": {\n    "module": "ES2020",\n    "moduleResolution": "node16",\n  },\n  "ts-node": {\n    "esm": true\n  }\n}\n')),(0,l.kt)("h3",{id:"update-packagejson-to-module-type"},'Update package.json to "module" type'),(0,l.kt)("p",null,"Add ",(0,l.kt)("inlineCode",{parentName:"p"},'"type": "module"')," to your package.json so that your files will be loaded as ESM modules"),(0,l.kt)("h3",{id:"update-references-to-bin-scripts"},"Update references to bin scripts"),(0,l.kt)("p",null,"You will need to update the references to your bin scripts to the bin scripts with the ",(0,l.kt)("inlineCode",{parentName:"p"},".js")," extension. In the ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," you will need to update the ",(0,l.kt)("inlineCode",{parentName:"p"},"bin")," like so:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'  "bin": {\n    "my-cli": "./bin/run"\n  },\n')),(0,l.kt)("p",null,"to"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'  "bin": {\n    "my-cli": "./bin/run.js"\n  },\n')),(0,l.kt)("p",null,"You may have references to the bin scripts in your ",(0,l.kt)("inlineCode",{parentName:"p"},".vscode/launch.json")," or in the ",(0,l.kt)("inlineCode",{parentName:"p"},"scripts")," of your ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),". You'll need to update these as well."),(0,l.kt)("h3",{id:"update-mocharc-settings"},"Update mocharc settings"),(0,l.kt)("p",null,"In order for your mocha tests to run, you'll need to make a couple of changes:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Add the following to the ",(0,l.kt)("inlineCode",{parentName:"li"},".mocharc.json"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "node-option": [\n    "loader=ts-node/esm"\n  ]\n}\n')),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Update ",(0,l.kt)("inlineCode",{parentName:"li"},"test/helpers/init.js"))),(0,l.kt)("p",null,"If your plugin was generated ",(0,l.kt)("inlineCode",{parentName:"p"},"oclif generate")," then you likely have a ",(0,l.kt)("inlineCode",{parentName:"p"},"test/helpers/init.js")," file that needs to be updated. You can either update the file extension to ",(0,l.kt)("inlineCode",{parentName:"p"},".cjs")," or update the ",(0,l.kt)("inlineCode",{parentName:"p"},"require")," at the top of the file to an ",(0,l.kt)("inlineCode",{parentName:"p"},"import"),","),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import path from 'node:path'\n")),(0,l.kt)("p",null,"Alternatively, you can safely delete this file since it's no longer necessary."))}g.isMDXComponent=!0}}]);